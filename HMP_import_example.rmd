`r opts_chunk$set(cache=TRUE, fig.width=8)`
<link href="http://joey711.github.com/phyloseq/markdown.css" rel="stylesheet"></link>

# Human Microbiome Project

Example importing into [phyloseq](http://joey711.github.com/phyloseq/) the files produced by [Qiime](http://qiime.org/) run on [the HMPv35 dataset](http://hmpdacc.org/micro_analysis/microbiome_analyses.php), which is avilable from [HMP-DACC](http://hmpdacc.org/). Even more specifically this data is from [the HMP QIIME Community Profiling data page](http://hmpdacc.org/HMQCP/). This is important to note because there are also "parallel versions" of this data [generated by mothur](http://hmpdacc.org/HMMCP/) which could also be imported by phyloseq; and there are also a growing number of data links and displays added to the main HMP-DACC page that might otherwise obfuscate where this data came from. However, the precise links are shown in the code below. In this way we are demonstrating both the `import_qiime` function in phyloseq, as well as the import of web-facing data in general using R.

Note that this is a document produced by [the markdown package](http://cran.r-project.org/web/packages/markdown/index.html) from an [R Markdown file](http://rstudio.org/docs/authoring/using_markdown). Markdown is a simple formatting syntax for authoring web pages, and in this case the structure includes reproducible code.

## Load [the phyloseq package](http://joey711.github.com/phyloseq/)
```{r load_phyloseq, message=FALSE}
library("phyloseq"); packageVersion("phyloseq")
```

## Download the files to a temporary location 
Note that R's file handling is sophisticated enough that you do not need to unpack/unzip the `.gz`- or `.bz2`-compressed files. They are understood automatically.

### Download the OTU abundance file
Create a temporary local file where there large otu-tax file will be downloaded and read-from.

```{r download-otutax}
temp_otutax = tempfile()
otu_url     = "http://downloads.hmpdacc.org/data/HMQCP/otu_table_psn_v35.txt.gz"
download.file(otu_url, temp_otutax)
```
### Download the Sample Map File

```{r download-sample-map}
temp_map = tempfile()
map_url  = "http://downloads.hmpdacc.org/data/HMQCP/v35_map_uniquebyPSN.txt.bz2"
download.file(map_url, temp_map)
```

### Download the phylogenetic tree
```{r download-tree}
temp_tree = tempfile()
tree_url = "http://downloads.hmpdacc.org/data/HMQCP/rep_set_v35.tre.gz"
download.file(tree_url, temp_tree)
```

It turns out that the tree has weird quotes added around tip names, for example. The following will read the `.gz` tree directly (no extra uncompression step needed).
```{r import-tree-fix}
tree = read_tree(temp_tree) 
head(taxa_names(tree))
```
These extra quotes ( `"'"` ) must be removed/replaced. This can be accomplished using the following line
```{r}
tree$tip.label = substr(taxa_names(tree), 2, nchar(taxa_names(tree))-1)
```

### Download the representative sequences
Unfortunately, the `readDNAStringSet` function for importing the representative sequences -- which we will call `refseq` (for "reference sequences") -- does not accept standard R file connections for reading files, possibly because it is performing the parsing at a very low level? In any case, unlike the other files we are importing, this must be unzipped first to an uncompressed `.fna` file, before we read and parse.
```{r download-refseq}
zipped_refseq   = tempfile()
unzipped_rsfile = tempfile()
refseq_url = "http://downloads.hmpdacc.org/data/HMQCP/rep_set_v35.fna.gz"
download.file(refseq_url, zipped_refseq)
```
I use the `gzfile` function to open an R connection to the `.gz` compressed representative sequence file that we just downloaded. Then, use `readLines` and `writeLines` to essentially "pipe" this uncompressed to our second temporary file, called `unzipped_rsfile`.
```{r decompress-refseq}
uzrefseqfile = gzfile(zipped_refseq)
writeLines(readLines(uzrefseqfile), unzipped_rsfile)
```

Now that I have an uncompressed version of the file saved in as temporary (but known) file, I can use the `readDNAStringSet` function without error, and store the initial import result as the object, `refseq`.
```{r decompress}
library("Biostrings")
refseq = readDNAStringSet(unzipped_rsfile)
refseq
```


## Import the Data and Create phyloseq Object.
I have included a timing function call so that you can see how long this large file took to import using my laptop. Also, the number of "chunks" is shown by the number of "dots" printed after the function call. Note that the phylogenetic tree was already imported, slightly modified in the previous code chunk, and we want this to provide this `tree` as the tree argument, rather than the raw tree file, which won't exactly match the `taxa_names` in the OTU-Tax file.

```{r import-HMPv35}
system.time(HMPv35 = import_qiime(temp_otutax, temp_map, tree, refseqs, chunk.size=2000L))
```

## Investigate Some Basic Features of HMPv35
For more advanced tools for exploring the data, see [additional phyloseq documentation](http://joey711.github.com/phyloseq/)

```{r explore-HMPv35}
ntaxa(HMPv35)
nsamples(HMPv35)
sample_variables(HMPv35)
```

## Save HMPv35 to an RData File
Save `HMPv35` to an `".RData"`" file so that you don't have to run this import ever again. In the following example, I'm saving it to a particular directory I have synced with DropBox. Your preferred file path for saving R data may (and probably should) vary.

```{r}
save(HMPv35, file="~/Dropbox/R/import_HMP_examples/HMPv35.RData")
```

## Alternatively, Download the Processed File from Us
We have already run this import code several times during testing and timing. This [already-imported `HMPv35` from QIIME output dataset](http://cloud.github.com/downloads/joey711/phyloseq/HMPv35.RData) is available from [the phyloseq downloads page](https://github.com/joey711/phyloseq/downloads). Happily, this file will load in very quickly compared with importing it again from the data files.

